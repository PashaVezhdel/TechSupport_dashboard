{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>IT Service Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'dashboard/css/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid px-4">
            <span class="navbar-brand h1 mb-0">üñ•Ô∏è IT Support Monitor</span>
            <div class="d-flex align-items-center gap-3">
                <span id="autoRefreshStatus" class="badge bg-success refresh-badge"></span>
                <span class="text-white small">–í—Å—å–æ–≥–æ: <strong id="totalCount">{{ total }}</strong></span>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="card p-3 shadow-sm">
            <form id="filterForm" onsubmit="updateData(); return false;" class="row g-3 align-items-end">
                <div class="col-md-7">
                    <div class="row g-2 align-items-end filter-group">
                        <div class="col-md-4">
                            <label class="form-label fw-bold mb-1 small">üìÖ –í—ñ–¥:</label>
                            <input type="date" id="start_date" name="start_date" class="form-control form-control-sm" value="{{ selected_start }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold mb-1 small">üìÖ –î–æ:</label>
                            <input type="date" id="end_date" name="end_date" class="form-control form-control-sm" value="{{ selected_end }}">
                        </div>
                        <div class="col-md-4 d-flex gap-1">
                            <button type="submit" class="btn btn-primary btn-sm w-100 fw-bold">–ü–æ—à—É–∫</button>
                            <a href="/" class="btn btn-outline-secondary btn-sm w-25 text-center">üîÑ</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-5 ps-3">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label fw-bold mb-1 small">‚è±Ô∏è –û–Ω–æ–≤–ª–µ–Ω–Ω—è:</label>
                            <select id="refreshInterval" class="form-select form-select-sm" onchange="setupRefresh()">
                                <option value="0">–í–∏–º–∫–Ω—É—Ç–∏</option>
                                <option value="5" selected>5—Å</option>
                                <option value="10">10—Å</option>
                                <option value="30">30—Å</option>
                                <option value="60">1—Ö–≤</option>
                                <option value="300">5—Ö–≤</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <button type="button" onclick="updateData()" class="btn btn-success btn-sm w-100 fw-bold">‚ö° –û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="charts-grid">
            <div class="card"><div class="card-header text-center">üìä –°—Ç–∞—Ç—É—Å–∏</div><div class="card-body"><canvas id="statusChart"></canvas></div></div>
            <div class="card"><div class="card-header text-center">üî• –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω—ñ—Å—Ç—å</div><div class="card-body"><canvas id="priorityChart"></canvas></div></div>
            <div class="card"><div class="card-header text-center">üèÜ –¢–æ–ø –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤</div><div class="card-body"><canvas id="workerChart"></canvas></div></div>
            <div class="card"><div class="card-header text-center">üìà –î–∏–Ω–∞–º—ñ–∫–∞ –∑–∞—è–≤–æ–∫</div><div class="card-body"><canvas id="monthChart"></canvas></div></div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="text-start">üìù –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫</span>
                <div class="input-group input-group-sm" style="width: 280px;">
                    <span class="input-group-text bg-white border-end-0">üîé</span>
                    <input type="text" id="tableSearch" class="form-control border-start-0" placeholder="–ü–æ—à—É–∫ –≤ –ø–æ—Ç–æ—á–Ω–æ–º—É —Å–ø–∏—Å–∫—É..." onkeyup="filterTable()">
                </div>
            </div>
            <div class="table-container">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 80px">–ß–∞—Å</th>
                            <th style="width: 100px">ID</th>
                            <th style="width: 150px">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                            <th>–û–ø–∏—Å –ø—Ä–æ–±–ª–µ–º–∏</th>
                            <th style="width: 120px">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</th>
                            <th style="width: 120px">–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsTable">
                        {% for t in tickets_list %}
                        <tr>
                            <td class="text-muted small">{{ t.date }}</td>
                            <td class="fw-bold text-primary">#{{ t.id }}</td>
                            <td>{{ t.name }}</td>
                            <td class="text-truncate" style="max-width: 400px;">{{ t.desc }}</td>
                            <td><span class="badge bg-light text-dark border">{{ t.priority }}</span></td>
                            <td><span class="badge bg-secondary" style="font-size: 0.75rem;">{{ t.status }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="{% static 'dashboard/js/scripts.js' %}"></script>
    <script>
        window.onload = function() {
            const initialData = {
                status_labels: {{ status_labels|safe }},
                status_data: {{ status_data|safe }},
                priority_labels: {{ priority_labels|safe }},
                priority_data: {{ priority_data|safe }},
                worker_labels: {{ worker_labels|safe }},
                worker_data: {{ worker_data|safe }},
                month_labels: {{ month_labels|safe }},
                month_data: {{ month_data|safe }}
            };
            initCharts(initialData);
            const saved = localStorage.getItem('refreshInterval');
            if (saved) document.getElementById('refreshInterval').value = saved;
            setupRefresh();
        };
    </script>
</body>
</html>