<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>IT Service Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f1f3f5; font-size: 0.9rem; margin: 0; }
        .navbar { padding: 0.5rem 1rem; }
        .main-container { padding: 10px 20px; display: flex; flex-direction: column; gap: 10px; }
        
        .charts-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
        }

        .card { border: none; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-header { background-color: #fff; font-weight: bold; padding: 8px; font-size: 1rem; text-align: center; border-bottom: 1px solid #eee; }
        
        .card-body { padding: 10px; height: 240px; position: relative; }
        
        .table-card { margin-top: 5px; }
        .table-container { max-height: 300px; overflow-y: auto; }
        .table thead { position: sticky; top: 0; background: #f8f9fa; z-index: 10; }
        
        .status-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 10px; }
        .refresh-badge { font-size: 0.8rem; padding: 4px 10px; border-radius: 15px; }
        .filter-group { border-right: 1px solid #dee2e6; padding-right: 15px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand h1 mb-0">üñ•Ô∏è IT Support Monitor</span>
            <div class="d-flex align-items-center gap-3">
                <span id="autoRefreshStatus" class="badge bg-success refresh-badge"></span>
                <span class="text-white small">–í—Å—å–æ–≥–æ: <strong id="totalCount">{{ total }}</strong></span>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="card p-2 shadow-sm">
            <form id="filterForm" class="row g-2 align-items-end">
                <div class="col-md-6">
                    <div class="row g-2 align-items-end filter-group">
                        <div class="col-md-4">
                            <label class="form-label fw-bold mb-1 small">üìÖ –í—ñ–¥:</label>
                            <input type="date" name="start_date" class="form-control form-control-sm" value="{{ selected_start }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold mb-1 small">üìÖ –î–æ:</label>
                            <input type="date" name="end_date" class="form-control form-control-sm" value="{{ selected_end }}">
                        </div>
                        <div class="col-md-4 d-flex gap-1">
                            <button type="submit" class="btn btn-primary btn-sm w-100 fw-bold">–ü–æ—à—É–∫</button>
                            <a href="/" class="btn btn-outline-secondary btn-sm w-25 text-center">üîÑ</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 ps-2">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label fw-bold mb-1 small">‚è±Ô∏è –û–Ω–æ–≤–ª–µ–Ω–Ω—è:</label>
                            <select id="refreshInterval" class="form-select form-select-sm">
                                <option value="0">Off</option>
                                <option value="5" selected>5—Å</option>
                                <option value="30">30—Å</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <button type="button" onclick="updateData()" class="btn btn-success btn-sm w-100 fw-bold">‚ö° –û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="charts-grid">
            <div class="card"><div class="card-header">üìä –°—Ç–∞—Ç—É—Å–∏</div><div class="card-body"><canvas id="statusChart"></canvas></div></div>
            <div class="card"><div class="card-header">üî• –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω—ñ—Å—Ç—å</div><div class="card-body"><canvas id="priorityChart"></canvas></div></div>
            <div class="card"><div class="card-header">üèÜ –¢–æ–ø –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤</div><div class="card-body"><canvas id="workerChart"></canvas></div></div>
            <div class="card"><div class="card-header">üìà –î–∏–Ω–∞–º—ñ–∫–∞ –∑–∞—è–≤–æ–∫</div><div class="card-body"><canvas id="monthChart"></canvas></div></div>
        </div>

        <div class="card table-card shadow-sm mb-3">
            <div class="card-header text-start">üìù –û—Å—Ç–∞–Ω–Ω—ñ –∑–∞—è–≤–∫–∏</div>
            <div class="table-container">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 80px">–ß–∞—Å</th>
                            <th style="width: 100px">ID</th>
                            <th style="width: 150px">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                            <th>–û–ø–∏—Å –ø—Ä–æ–±–ª–µ–º–∏</th>
                            <th style="width: 120px">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</th>
                            <th style="width: 120px">–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsTable">
                        {% for t in tickets_list %}
                        <tr>
                            <td class="text-muted small">{{ t.date }}</td>
                            <td class="fw-bold text-primary">#{{ t.id }}</td>
                            <td>{{ t.name }}</td>
                            <td class="text-truncate" style="max-width: 300px;">{{ t.desc }}</td>
                            <td><span class="badge bg-light text-dark border">{{ t.priority }}</span></td>
                            <td><span class="badge bg-secondary status-badge">{{ t.status }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        const chartOptions = { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } } 
        };

        function initCharts() {
            charts.status = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: { labels: {{ status_labels|safe }}, datasets: [{ data: {{ status_data|safe }}, backgroundColor: ['#28a745', '#ffc107', '#17a2b8', '#6c757d'] }] },
                options: { ...chartOptions, cutout: '65%' }
            });
            charts.priority = new Chart(document.getElementById('priorityChart'), {
                type: 'bar',
                data: { labels: {{ priority_labels|safe }}, datasets: [{ label: '–ó–∞—è–≤–∫–∏', data: {{ priority_data|safe }}, backgroundColor: ['#dc3545', '#fd7e14', '#007bff'] }] },
                options: { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
            charts.worker = new Chart(document.getElementById('workerChart'), {
                type: 'bar',
                data: { labels: {{ worker_labels|safe }}, datasets: [{ label: '–ó–∞–∫—Ä–∏—Ç–æ', data: {{ worker_data|safe }}, backgroundColor: '#6f42c1' }] },
                options: { ...chartOptions, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
            charts.month = new Chart(document.getElementById('monthChart'), {
                type: 'line',
                data: { labels: {{ month_labels|safe }}, datasets: [{ label: '–ö—ñ–ª—å–∫—ñ—Å—Ç—å', data: {{ month_data|safe }}, borderColor: '#007bff', fill: true, tension: 0.4 }] },
                options: { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }

        async function updateData() {
            const params = new URLSearchParams(new FormData(document.getElementById('filterForm')));
            const response = await fetch(`/api/data/?${params.toString()}`);
            const data = await response.json();
            document.getElementById('totalCount').innerText = data.total;
            const tbody = document.getElementById('ticketsTable');
            tbody.innerHTML = data.tickets_list.map(t => `
                <tr>
                    <td class="text-muted small">${t.date}</td>
                    <td class="fw-bold text-primary">#${t.id}</td>
                    <td>${t.name}</td>
                    <td class="text-truncate" style="max-width: 300px;">${t.desc}</td>
                    <td><span class="badge bg-light text-dark border">${t.priority}</span></td>
                    <td><span class="badge bg-secondary status-badge">${t.status}</span></td>
                </tr>
            `).join('');
            Object.keys(charts).forEach(key => {
                charts[key].data.labels = data[key + '_labels'];
                charts[key].data.datasets[0].data = data[key + '_data'];
                charts[key].update();
            });
        }

        function setupRefresh() {
            const interval = document.getElementById('refreshInterval').value;
            localStorage.setItem('refreshInterval', interval);
            const badge = document.getElementById('autoRefreshStatus');
            if (window.refreshTimer) clearInterval(window.refreshTimer);
            if (interval > 0) {
                badge.innerText = `–ê–≤—Ç–æ: ${interval}—Å`;
                badge.className = "badge bg-success refresh-badge";
                window.refreshTimer = setInterval(updateData, interval * 1000);
            } else { badge.innerText = "OFF"; badge.className = "badge bg-secondary refresh-badge"; }
        }

        window.onload = function() {
            initCharts();
            const saved = localStorage.getItem('refreshInterval');
            if (saved) document.getElementById('refreshInterval').value = saved;
            setupRefresh();
        };

        document.getElementById('refreshInterval').addEventListener('change', setupRefresh);
        document.getElementById('filterForm').addEventListener('submit', (e) => { e.preventDefault(); updateData(); });
    </script>
</body>
</html>